# Tsuchinoko V1.7.0 要件定義書

> **テーマ**: Bridge Revolution - 相互運用性の完成
> **作成日**: 2026-01-10
> **バージョン**: 1.7.0 (Maximum A Definition)
> **ステータス**: 確定版 (Reviewed)

---

## 1. 概要 (Overview)

Tsuchinoko V1.7.0 では、**Remote Object Handle (リモートオブジェクトハンドル)** パターンを導入し、Rust 側から Python オブジェクトを「透過的」かつ「双方向」に操作可能にする。

本バージョンでは **「Maximum A (現実主義)」** スコープを採用し、実用的なデータ操作に必要な機能を網羅しつつ、試験項目の爆発を防ぐ。

### 1.1 スコープ定義

| 機能カテゴリ | V1.7.0 (Maximum A) | V1.7.1 (Maximum B - Future) |
|---|---|---|
| **基本操作** | `call_method` | - |
| **属性操作** | `get_attribute` | `set_attribute`, `del_attribute` |
| **要素操作** | `get_item`, `slice` (リスト/辞書/ndarray参照) | `set_item`, `del_item` |
| **呼び出し** | - | `call` (関数/クラスの直接呼び出し) |
| **イテレータ** | `iter`, `iter_next_batch` (高速化)<br>※ `next` (単要素)は非提供 | `to_list`, `to_numpy`, `reduce` (Materialize) |
| **エラー処理** | 完全仕様化 (Code + Op + Traceback) | - |

---

## 2. アーキテクチャ詳細

### 2.1 Remote Handle Pattern

Rust 側は `Handle ID` のみを保持し、Python Worker 内の `_OBJECT_STORE` に実体を維持する。
操作は全て JSON コマンド (RPC) を介して行われる。

### 2.2 プロトコル設計 (Enhanced RPC)

リクエストとレスポンスを厳格な Tagged Union で定義し、エラーハンドリングを統一する。

#### A. レスポンス形式 (統一)

全てのコマンド戻り値は以下のいずれかになる。

**成功 (Success)**
```json
{ 
  "kind": "ok", 
  "value": { "kind": "handle", "id": "...", ... }, // または Value/Container
  "meta": { ... } // (Optional)
}
```

**失敗 (Error)**
```json
{
  "kind": "error",
  "error": {
    "code": "PyException",
    "py_type": "IndexError",
    "message": "list index out of range",
    "traceback": "Traceback (most recent call last):...",
    "op": { "cmd": "get_item", "target": "obj_1", "key": {"kind":"value","value":999} }
  }
}
```

#### B. コマンドセット (Maximum A)

1.  **Method Call**
    ```json
    { "cmd": "call_method", "target": "h_1", "method": "append", "args": [...] }
    ```

2.  **Attribute Access** (NEW)
    ```json
    { "cmd": "get_attribute", "target": "h_1", "name": "shape" }
    ```
    *   用途: `df.shape`, `df.columns` 等のプロパティ取得。
    *   **Security**: `get_attribute` は `_` で始まる属性および `__dunder__` 属性へのアクセスを禁止する（`obj.__dict__` 等の遮断）。

3.  **Item Access** (NEW)
    ```json
    { "cmd": "get_item", "target": "h_1", "key": { "kind": "value", "value": "A" } }
    ```
    *   用途: `df["A"]`, `dict["key"]`, `list[0]`。
    *   **Slice**:
        ```json
        { 
          "cmd": "slice", 
          "target": "h_1", 
          "start": { "kind": "value", "value": 0 }, 
          "stop": { "kind": "value", "value": 10 }, 
          "step": { "kind": "value", "value": 1 } 
        }
        ```
        *   `start`, `stop`, `step` も **Tagged Union** (Value または Handle) で指定可能とする。これにより `df[i : i+N]` のような動的スライスに対応する。

4.  **Iterator (Batched)** (NEW)
    *   `iter`: Handle から Iterator Handle を生成。
    *   `iter_next_batch`: 複数要素をまとめて取得 (IPC削減)。
    ```json
    { "cmd": "iter_next_batch", "target": "iter_h_1", "batch_size": 1024 }
    ```
    *   Iterator は遅延評価であり、`batch_size` 単位で Python 側から Rust 側へ `Container(list)` として転送される。
    *   **終了条件 (StopIteration)**: `meta` フィールドの `done: true` で通知する（案A採用）。
    ```json
    {
      "kind": "ok",
      "value": { "kind": "list", "items": [] },
      "meta": { "done": true }
    }
    ```

---

## 3. エラーハンドリング完全仕様

V1.5.2 の `Result` 型統一思想を RPC レベルまで拡張する。

### 3.1 エラーコード体系

| Code | 意味 | Rust対応 |
|---|---|---|
| `ProtocolError` | JSON形式不正、未知のコマンド | `BridgeError::Protocol` |
| `StaleHandle` | IDが存在しない (GC済み等) | `BridgeError::StaleHandle` |
| `WorkerCrash` | プロセス消失 | `BridgeError::WorkerCrash` |
| `ValueTooLarge` | `.to_value()` 制限超過 | `BridgeError::ValueTooLarge` |
| `SecurityViolation` | 禁止操作 (`eval`, `__dict__`等) | `BridgeError::Security` |
| `PythonException` | Python 側の例外発生 | `BridgeError::PythonException(msg, type)` |
| `TypeMismatch` | 要求された操作が対象型で不可 | `BridgeError::TypeMismatch` |

---

## 4. 非機能要件 (NFR)

| NFR-ID | カテゴリ | 要件 | 検証方法 |
|---|---|---|---|
| **PERF-01** | Process | 起動時のWorker立ち上げオーバーヘッド < 200ms | ストップウォッチ計測 |
| **PERF-02** | Latency | Handle経由のメソッド呼び出し < 5ms/回 (IPC) | ベンチマークテスト |
| **PERF-03** | Iterator | Batched Iterator により 1万要素の走査を 1秒以内 | 大量データ転送テスト |
| **REL-01** | Memory | Rust側の Drop と連動して Python 側のメモリが解放されること | 長時間ループ実行でメモリ監視 |
| **REL-02** | Robustness | Python側で例外発生時もプロセスを落とさずエラーを返す | 異常系テスト |
| **REL-03** | Compat | Windows/Linux/macOS で動作すること (`PYO3_PYTHON` 対応) | 異なるOSでの起動テスト |
| **REL-04** | Diagnosability | Worker起動時に環境診断情報をstderrに出力し、クラッシュ時に原因を特定可能にする | ログ確認 |
| **SEC-01** | Security | `eval`, `exec` 等の危険な関数の実行禁止 | セキュリティテスト |

---

## 5. ユースケース (Use Cases)

```mermaid
usecaseDiagram
    actor "Rust Runtime\n(Bridge)" as Bridge
    
    package "Python Worker (System)" {
        usecase "Create remote object\n(Load Library/Return Handle)" as UC1
        usecase "Call Method\n(.method())" as UC2
        usecase "Get Attribute\n(.attr)" as UC3
        usecase "Get Item / Slice\n([key], [i:j])" as UC4
        usecase "Iterate (Batched)\n(for x in obj)" as UC5
        usecase "Delete Object\n(Drop)" as UC6
        usecase "Throw Exception\n(Error Response)" as UC7
    }

    Bridge --> UC1
    Bridge --> UC2
    Bridge --> UC3
    Bridge --> UC4
    Bridge --> UC5
    Bridge --> UC6

    UC2 ..> UC7 : <<possible>>
    UC3 ..> UC7 : <<possible>>
    UC4 ..> UC7 : <<possible>>
    UC5 ..> UC7 : <<possible>>
    
    note right of UC5
        "iter_next_batch" creates
        chunks of data to reduce IPC
    end note

    note left of UC6
        Triggered by Rust's Drop trait
        (Idempotent)
    end note
```

---

## 6. 実装フェーズ (Updated)

**Phase 1: Worker & Protocol Core (Maximum A)**
*   `_OBJECT_STORE` 実装
*   `ok`/`error` 統一レスポンス形式実装
*   `call_method`, `get_attribute`, `get_item` 実装
*   `delete` (Idempotent) 実装

**Phase 2: Rust Bridge Core**
*   `PyObjectHandle` 定義
*   `Result<T, BridgeError>` マッピング実装
*   動的ディスパッチ機構 (`.attr()`, `.item()`, `.call()`)

**Phase 3: Iterator & Advanced Features**
*   Python: `iter`, `iter_next_batch` 実装
*   Rust: `PyIterator` ラッパー実装 (`Iterator` trait 実装)

**Phase 4: Semantic & Emitter**
*   `Any` 型の遅延解決
*   構文変換: `x.y` (attr), `x[y]` (item), `for x in y` (iter)

**Phase 5: Integration & Test**
*   `pandas`, `numpy` を用いた E2E テスト
*   NFR 検証

---

## 7. 次期バージョン (V1.7.1) への申し送り

以下の機能は V1.7.0 では実装せず、V1.7.1 以降での対応とする。

*   **Setters**: `set_attribute`, `set_item` (代入操作)
*   **Deleters**: `del_attribute`, `del_item`
*   **Call**: 関数オブジェクトやクラスインスタンスの直接呼び出し (`obj()`)
*   **Materialization**: `to_list`, `to_numpy` などの一括変換コマンド
*   **Reduce**: `sum`, `max` 等の Worker 側集計
