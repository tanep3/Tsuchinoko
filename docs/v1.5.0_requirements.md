# Tsuchinoko v1.5.0 要件定義書

> **著者**: Tane Channel Technology  
> **バージョン**: 1.5.0  
> **作成日**: 2026-01-04  
> **ステータス**: 計画中

---

## 1. 概要

### 1.1 バージョン目標

**v1.5.0: 基本文法の徹底的な網羅**

Python の基本機能（例外処理、コレクション、文字列、組み込み関数、スライス、Optional）を
網羅的にサポートし、「普通の Python スクリプト」が変換できる状態を目指す。

### 1.2 スコープ

| 対象 | 内容 |
|------|------|
| ✅ 含む | 例外処理、配列関連、文字列、組み込み関数、スライス、Optional |
| ❌ 含まない | 標準ライブラリ (json, re, datetime, os) → v1.6.0 |
| ❌ 含まない | 外部ライブラリ強化 (numpy 100%対応等) → v1.6.0 |

---

## 2. 機能要件

### 2.1 例外処理の強化

| ID | 機能 | 詳細 | 優先度 | 状態 |
|----|------|------|--------|------|
| EX-001 | 特定例外型 | `except ValueError:` など例外型指定 | 高 | - |
| EX-002 | 複数例外 | `except (TypeError, ValueError):` | 中 | - |
| EX-003 | 例外変数 | `except ValueError as e:` | 高 | - |
| EX-004 | finally | `try/except/finally` ブロック | 高 | - |
| EX-005 | raise from | `raise NewError from original` | 低 | - |
| EX-006 | else | `try/except/else` ブロック | 低 | - |

#### 変換方針

```python
# Python
try:
    result = risky_operation()
except ValueError as e:
    handle_error(e)
finally:
    cleanup()
```

```rust
// Rust (案)
let result = std::panic::catch_unwind(|| {
    risky_operation()
});
match result {
    Ok(v) => v,
    Err(e) => {
        // ValueError 相当の処理
        handle_error(e);
    }
}
// finally 相当: スコープ終了時の処理または defer パターン
cleanup();
```

---

### 2.2 配列関連の強化

#### 2.2.1 set 型の追加

| ID | 機能 | 詳細 | 優先度 | 状態 |
|----|------|------|--------|------|
| SET-001 | set リテラル | `{1, 2, 3}` → `HashSet::from([1, 2, 3])` | 高 | - |
| SET-002 | set() コンストラクタ | `set([1, 2, 3])` | 高 | - |
| SET-003 | add | `.add(x)` → `.insert(x)` | 高 | - |
| SET-004 | remove | `.remove(x)` | 中 | - |
| SET-005 | discard | `.discard(x)` (エラーなし削除) | 中 | - |
| SET-006 | union | `a | b` または `.union()` | 中 | - |
| SET-007 | intersection | `a & b` または `.intersection()` | 中 | - |
| SET-008 | difference | `a - b` または `.difference()` | 中 | - |
| SET-009 | in 演算子 | `x in s` → `s.contains(&x)` | 高 | - |

#### 2.2.2 list メソッドの網羅

| ID | 機能 | 変換先 | 優先度 | 状態 |
|----|------|--------|--------|------|
| LST-001 | .pop() | `.pop()` | 高 | - |
| LST-002 | .pop(i) | `.remove(i)` | 高 | - |
| LST-003 | .insert(i, x) | `.insert(i, x)` | 高 | - |
| LST-004 | .remove(x) | `.retain(\|v\| v != x)` (最初の1つ) | 中 | - |
| LST-005 | .extend(iter) | `.extend(iter)` | 高 | - |
| LST-006 | .clear() | `.clear()` | 中 | - |

#### 2.2.3 dict メソッドの網羅

| ID | 機能 | 変換先 | 優先度 | 状態 |
|----|------|--------|--------|------|
| DCT-001 | .keys() | `.keys()` | 高 | - |
| DCT-002 | .values() | `.values()` | 高 | - |
| DCT-003 | .get(k) | `.get(&k)` | 高 | - |
| DCT-004 | .get(k, default) | `.get(&k).unwrap_or(&default)` | 高 | - |
| DCT-005 | .pop(k) | `.remove(&k)` | 中 | - |
| DCT-006 | .update(other) | `.extend(other)` | 中 | - |
| DCT-007 | .setdefault(k, v) | `.entry(k).or_insert(v)` | 低 | - |

---

### 2.3 文字列メソッドの網羅

| ID | 機能 | 変換先 | 優先度 | 状態 |
|----|------|--------|--------|------|
| STR-001 | .replace(old, new) | `.replace(old, new)` | 高 | - |
| STR-002 | .startswith(prefix) | `.starts_with(prefix)` | 高 | - |
| STR-003 | .endswith(suffix) | `.ends_with(suffix)` | 高 | - |
| STR-004 | .find(sub) | `.find(sub)` → `Option<usize>` | 高 | - |
| STR-005 | .rfind(sub) | `.rfind(sub)` | 中 | - |
| STR-006 | .index(sub) | `.find(sub).unwrap()` | 中 | - |
| STR-007 | .isdigit() | `.chars().all(char::is_numeric)` | 中 | - |
| STR-008 | .isalpha() | `.chars().all(char::is_alphabetic)` | 中 | - |
| STR-009 | .isalnum() | `.chars().all(char::is_alphanumeric)` | 中 | - |
| STR-010 | .isupper() | `.chars().all(char::is_uppercase)` | 低 | - |
| STR-011 | .islower() | `.chars().all(char::is_lowercase)` | 低 | - |
| STR-012 | .zfill(width) | `format!("{:0>width$}", s)` | 低 | - |
| STR-013 | .ljust(width) | `format!("{:<width$}", s)` | 低 | - |
| STR-014 | .rjust(width) | `format!("{:>width$}", s)` | 低 | - |
| STR-015 | .center(width) | `format!("{:^width$}", s)` | 低 | - |
| STR-016 | .count(sub) | `.matches(sub).count()` | 中 | - |

---

### 2.4 組み込み関数の残り

| ID | 機能 | 変換先 | 優先度 | 状態 |
|----|------|--------|--------|------|
| BLT-001 | input() | `std::io::stdin().read_line()` | 中 | - |
| BLT-002 | input(prompt) | `print!(); stdin().read_line()` | 中 | - |
| BLT-003 | round(x) | `x.round()` | 高 | - |
| BLT-004 | round(x, n) | `(x * 10^n).round() / 10^n` | 中 | - |
| BLT-005 | isinstance(x, T) | 型チェック（コンパイル時解決） | 低 | - |
| BLT-006 | type(x) | 非対応（静的型付け） | - | ❌ |
| BLT-007 | hash(x) | `std::hash::Hash` 実装 | 低 | - |
| BLT-008 | id(x) | 非対応（Rustのアドレス取得は別概念） | - | ❌ |
| BLT-009 | chr(n) | `char::from_u32(n)` | 中 | - |
| BLT-010 | ord(c) | `c as u32` | 中 | - |
| BLT-011 | bin(x) | `format!("{:b}", x)` | 低 | - |
| BLT-012 | hex(x) | `format!("{:x}", x)` | 低 | - |
| BLT-013 | oct(x) | `format!("{:o}", x)` | 低 | - |

---

### 2.5 スライス完全対応

| ID | 機能 | 例 | 変換先 | 優先度 | 状態 |
|----|------|-----|--------|--------|------|
| SLC-001 | 基本 | `arr[1:3]` | `arr[1..3]` | ✅ 対応済み | ✅ |
| SLC-002 | 負のインデックス | `arr[-1]` | `arr[arr.len()-1]` | ✅ 対応済み | ✅ |
| SLC-003 | 開始省略 | `arr[:3]` | `arr[..3]` | ✅ 対応済み | ✅ |
| SLC-004 | 終了省略 | `arr[1:]` | `arr[1..]` | ✅ 対応済み | ✅ |
| SLC-005 | ステップ指定 | `arr[::2]` | `.iter().step_by(2)` | 高 | - |
| SLC-006 | 逆順 | `arr[::-1]` | `.iter().rev()` | 高 | - |
| SLC-007 | 範囲+ステップ | `arr[1:10:2]` | `arr[1..10].iter().step_by(2)` | 中 | - |
| SLC-008 | 負のステップ | `arr[10:1:-1]` | 複雑な変換 | 低 | - |

#### 変換方針

```python
# Python
evens = arr[::2]      # 偶数インデックス
reversed_arr = arr[::-1]  # 逆順
```

```rust
// Rust
let evens: Vec<_> = arr.iter().step_by(2).cloned().collect();
let reversed_arr: Vec<_> = arr.iter().rev().cloned().collect();
```

---

### 2.6 None / Optional の深い対応

| ID | 機能 | 例 | 変換先 | 優先度 | 状態 |
|----|------|-----|--------|--------|------|
| OPT-001 | or パターン | `x or default` | `x.unwrap_or(default)` | 高 | - |
| OPT-002 | and 短絡 | `x and x.method()` | `x.map(\|v\| v.method())` | 中 | - |
| OPT-003 | 三項演算子 | `x if x else y` | `x.unwrap_or(y)` | 中 | - |
| OPT-004 | None チェック連鎖 | `a and a.b and a.b.c` | `a.as_ref().and_then(\|a\| a.b.as_ref())` | 低 | - |
| OPT-005 | is None (済) | `x is None` | `x.is_none()` | ✅ 対応済み | ✅ |
| OPT-006 | is not None (済) | `x is not None` | `x.is_some()` | ✅ 対応済み | ✅ |

#### 変換方針

```python
# Python
result = value or "default"
safe_call = obj and obj.method()
```

```rust
// Rust
let result = value.unwrap_or("default".to_string());
let safe_call = obj.as_ref().map(|o| o.method());
```

---

## 3. 非機能要件

| NFR-ID | カテゴリ | 要件 | 検証方法 |
|--------|----------|------|----------|
| NFR-001 | カバレッジ | Python 構文カバレッジ 80% 達成 | supported_features.md 更新 |
| NFR-002 | テスト | 新機能ごとに単体テスト作成 | cargo test |
| NFR-003 | リグレッション | 既存テスト 54件 + 新規テストすべてパス | run_regression_tests.py |
| NFR-004 | ドキュメント | supported_features.md 更新 | レビュー |

---

## 4. 実装フェーズ

```
Phase 1: 例外処理 (EX-001 ~ EX-006)
    ↓
Phase 2: 配列関連 (SET-*, LST-*, DCT-*)
    ↓
Phase 3: 文字列メソッド (STR-001 ~ STR-016)
    ↓
Phase 4: 組み込み関数 (BLT-001 ~ BLT-013)
    ↓
Phase 5: スライス (SLC-005 ~ SLC-008)
    ↓
Phase 6: Optional (OPT-001 ~ OPT-004)
    ↓
Phase 7: ドキュメント & リリース
```

---

## 5. v1.6.0 への引き継ぎ事項

以下は v1.5.0 のスコープ外とし、v1.6.0 で対応する：

- 標準ライブラリ Native 対応 (json, re, datetime, os)
- 外部ライブラリ Top5 の徹底サポート
- numpy 100% 互換性

---

## 6. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| スライスのステップ指定が複雑 | 実装遅延 | 基本パターンのみ先行対応 |
| 例外型のマッピングが不完全 | 互換性低下 | 主要な例外型に絞る |
| Optional 変換の判定が難しい | 誤変換 | 型ヒント必須化で対応 |

---

## 7. 成功基準

- [ ] 全機能要件の実装完了
- [ ] Python 構文カバレッジ 80% 達成
- [ ] 全テストパス（既存 + 新規）
- [ ] ドキュメント更新完了
- [ ] v1.5.0 タグ付け & リリース
