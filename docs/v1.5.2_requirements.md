# Tsuchinoko v1.5.2 要件定義書

> **著者**: Tane Channel Technology  
> **バージョン**: v1.5.2  
> **作成日**: 2026-01-05  
> **最終更新**: 2026-01-06

---

## 0. 用語定義

### 0.1 「Result 型統一」とは - 言語仕様

**定義**：
Python の例外機構を、生成Rustコード上で `Result<T, TsuchinokoError>` により表現すること。

**具体的仕様**

1. **例外が発生し得る関数は `Result` を返す**
   - `fn f(...) -> Result<T, TsuchinokoError>`
2. **raise は `Err` を返す**
   - `raise ValueError("x")` → `return Err(TsuchinokoError::new("ValueError", "x", None))`
3. **例外の伝播は `?` を用いる**
   - `g()` が `Result` のとき、`g()?;` で上位へ伝播
4. **try/except/else/finally は `match` と `Ok/Err` 分岐で再現する**
5. **raise from は cause を保持してチェーン化する**
   - `raise A("m") from e` → `Err(TsuchinokoError::new("A","m", Some(e)))`

**Result 伝播の範囲**

> try/except で捕捉されない例外は、呼び出し関係に従って上位関数へ伝播する。
> これを実現するため、必要な範囲の関数は `Result<T, TsuchinokoError>` に昇格する。

---

### 0.2 「案1 - catch_unwind」とは - 保険・診断

**定義**：
生成Rustコードが **想定外に panic** した場合に、`std::panic::catch_unwind` で捕捉し、`TsuchinokoError` kind="InternalError" に変換する方式。

**対象**：`unwrap()` 失敗、`index out of bounds`、`todo!()`、`assert!()` 失敗

**対象外**：`abort()`、Segfault、UB

> 案1 は Python例外の意味論変換 Result統一 とは独立に実装する診断機能である。

---

### 0.3 「案2 - 外部境界Result化」とは - 実装規約

**定義**：
PyO3・常駐プロセスなど **外部呼び出し境界** での失敗を panic にせず `Result<_, TsuchinokoError>` として返す方式。

**規約**

- ❌ `unwrap()` で落とさない
- ✅ 例外・失敗は `Err(TsuchinokoError)` へ変換して返す
- ✅ Python例外情報を欠損させない
- ✅ `raise from` の `cause` として利用可能な形で保持する

> 外部境界での失敗は panic 化せず `Err(TsuchinokoError)` として返す。
> プロセス死亡は対象外とし、常駐プロセス方式では worker 死亡を検知して `WorkerCrashed` として例外化する。

---

## 1. 守備範囲マトリクス

| 種類 | 例 | Result統一 | 案2 外部境界 | 案1 panic回収 |
|------|-----|:---:|:---:|:---:|
| Python例外 | ValueError, TypeError | ◎ | ◎ | △ |
| raise / raise from | 例外チェーン | ◎ | ◎ | × |
| try/except/else/finally | 制御構造 | ◎ | △ | △ |
| 外部呼び出し失敗 | import失敗/属性なし | ◎ | ◎ | △ |
| 生成物のバグpanic | unwrap/OOB/todo | × | × | ◎ |
| abort/segfault/UB | プロセス死亡 | × | × | × |

※ ◎=主戦場 / △=副次的に効く / ×=対象外

---

## 2. 目的

Python の例外機構を Rust に正しく変換可能にする。

これにより：
- エラーの原因追跡が可能な品質の高いコードを生成
- 将来の async/await 対応への布石

---

## 3. スコープ

### 3.1 対象機能 - MUST

| ID | 機能 | 説明 |
|----|------|------|
| EX-001 | `raise NewError from e` | 例外チェーン、cause 保持 |
| EX-002 | `try/except/else` | 例外未発生時の else ブロック |
| EX-003 | Result 型統一 | 例外発生関数は `Result<T, TsuchinokoError>` を返す |
| EX-004 | 案2: 外部境界 Result 化 | PyO3/py_bridge の失敗を panic にしない |

### 3.2 対象機能 - SHOULD

| ID | 機能 | 説明 |
|----|------|------|
| EX-005 | 案1: catch_unwind 診断モード | 想定外 panic を InternalError へ変換 |
| EX-006 | エラーメッセージ改善 | Python 行番号と修正案を表示 |
| EX-007 | エラーチェーン表示 | デバッグ時に原因の連鎖を確認可能 |
| EX-008 | 型推論精度向上 | 関数戻り値型の追跡による推論精度改善 |

### 3.3 対象外

| 機能 | 理由 |
|------|------|
| 完全な traceback 再現 | v1.6.0 以降で検討 |
| カスタム例外クラス定義 | v1.6.0 以降で検討 |

---

## 4. 変換仕様

### 4.1 raise from 構文

**入力 - Python**:
```python
try:
    value = int("abc")
except ValueError as e:
    raise RuntimeError("変換に失敗しました") from e
```

**出力 - Rust**:
```rust
fn test_raise_from() -> Result<(), TsuchinokoError> {
    match "abc".parse::<i64>() {
        Ok(v) => Ok(()),
        Err(original) => {
            Err(TsuchinokoError::new(
                "RuntimeError",
                "変換に失敗しました",
                Some(TsuchinokoError::new("ValueError", &original.to_string(), None)),
            ))
        }
    }
}
```

### 4.2 Result 伝播

**入力 - Python**:
```python
def outer():
    inner()

def inner():
    raise ValueError("error")
```

**出力 - Rust**:
```rust
fn outer() -> Result<(), TsuchinokoError> {
    inner()?;  // ? で伝播
    Ok(())
}

fn inner() -> Result<(), TsuchinokoError> {
    Err(TsuchinokoError::new("ValueError", "error", None))
}
```

### 4.3 TsuchinokoError 型

```rust
pub struct TsuchinokoError {
    kind: String,      // "ValueError", "RuntimeError" など
    message: String,
    cause: Option<Box<TsuchinokoError>>,
}

impl TsuchinokoError {
    pub fn new(kind: &str, msg: &str, cause: Option<TsuchinokoError>) -> Self {
        Self {
            kind: kind.to_string(),
            message: msg.to_string(),
            cause: cause.map(Box::new),
        }
    }
}
```

---

## 5. 技術設計

### 5.1 AST 変更

```rust
// Stmt::Raise に cause 追加
Stmt::Raise {
    exception_type: String,
    message: Expr,
    cause: Option<Box<Expr>>,  // 追加: from 句
}

// Stmt::TryExcept に else_body 追加
Stmt::TryExcept {
    try_body: Vec<Stmt>,
    except_clauses: Vec<ExceptClause>,
    else_body: Option<Vec<Stmt>>,     // 追加: else ブロック
    finally_body: Option<Vec<Stmt>>,
}
```

### 5.2 IR 変更

```rust
IrNode::Raise {
    exc_type: String,
    message: Box<IrExpr>,
    cause: Option<Box<IrExpr>>,  // 追加
}

IrNode::TryBlock {
    try_body: Vec<IrNode>,
    except_body: Vec<IrNode>,
    else_body: Option<Vec<IrNode>>,  // 追加
    finally_body: Option<Vec<IrNode>>,
}
```

### 5.3 Emitter 変更

- `IrNode::Raise` を `Err(TsuchinokoError::new(...))` に変換
- `IrNode::TryBlock` を `match` 式に変換
- 関数の戻り値型を `Result<T, TsuchinokoError>` に昇格

---

## 6. 成功基準

| # | 基準 | 検証方法 |
|---|------|----------|
| 1 | `raise A from B` が cause 付きで生成される | 生成コード確認 |
| 2 | `try/except/else` の else が例外無しの場合のみ実行 | システムテスト |
| 3 | 外部呼び出し失敗が panic ではなく TsuchinokoError で返る | システムテスト |
| 4 | Result が呼び出し関係に従って伝播する | システムテスト |
| 5 | リグレッションテスト 62件 + 新規 全パス | リグレッション |

### 6.1 エラー表示の最低保証

```
Error: RuntimeError: 変換に失敗しました
Caused by: ValueError: invalid literal for int with base 10: 'abc'
```

---

## 7. 変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `src/bridge/tsuchinoko_error.rs` | TsuchinokoError 型定義 [NEW] |
| `src/parser/ast.rs` | `Stmt::Raise` に `cause`、`Stmt::TryExcept` に `else_body` 追加 |
| `src/parser/mod.rs` | `raise ... from ...` と `else:` ブロック パース対応 |
| `src/ir/nodes.rs` | `IrNode::Raise` と `IrNode::TryBlock` 拡張 |
| `src/semantic/analyze_statements.rs` | Result 型昇格解析 |
| `src/emitter/mod.rs` | `Err(...)` 生成、`match` 式変換 |
| `src/bridge/mod.rs` | 案2: 外部境界 Result 化 |

---

## 8. 実装フェーズ

| Phase | 作業内容 | 優先度 |
|-------|----------|--------|
| 1 | `TsuchinokoError` 型定義、AST 拡張 | MUST |
| 2 | Parser: `raise from`、`try/except/else` 対応 | MUST |
| 3 | 例外発生関数の Result 化 + 伝播解析 | MUST |
| 4 | Emitter: `match` 変換、`Err(...)` 生成 | MUST |
| 5 | 案2: 外部境界 Result 化 | MUST |
| 6 | 案1: `catch_unwind` 診断モード | SHOULD |

---

## 9. 設計理由 - Why Result?

### 9.1 async/await 対応への布石

将来の async/await 対応を見据え、panic ベースではなく Result 型を採用。

- `panic!` と async ランタイムは相性が悪い
- `Result<T, E>` と `?` は async/await と自然に組み合わせ可能
- Python の `async def` / `await` を将来変換するための前準備

### 9.2 Rust らしいエラー処理

- 関数シグネチャにエラー可能性が明示される
- コンパイル時に未処理のエラーが検出される
- ライブラリコードとの統合が容易

---

## 10. リスク

| リスク | 対策 |
|--------|------|
| 既存コードの破壊 | 各フェーズでリグレッションテスト実施 |
| Result 伝播の複雑化 | 段階的に実装、シンプルなケースから検証 |
