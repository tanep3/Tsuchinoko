# Tsuchinokoプロジェクト （Python to Rust Compiler）: 仕様書

---

## 1. 目的（SA：System Architecture）

Tsuchinoko は、PythonコードをRustコードへ変換する言語処理系である。本プロジェクトの主目的は、静的型付けコンパイル言語Rustの強力な型安全性と速度性を活用し、Pythonコードの意味構造を保ったまま正確なRustコードへ変換可能とすることにある。

特徴：

* Pythonの柔軟な構文に対応（リスト、タプル、関数、if/for文など）
* Rustの型安全、速度、ベクタ構造を活かした出力
* ノードベースの型推論とスコープ分離による精密なコード生成

---

## 2. データ構造（SA）

### 2.1 ASTノードラッパー構造

すべてのPython ASTノードを継承した `TsuchinokoNode` に変換し、独自の `emit_rust()` メソッドを定義。以下の拡張情報を保持する：

* `node_id`: 一意のノード識別子
* `var_type`: 推論された変数の型
* `parent_id`: 親のノード識別子（主にスコープを探すのに使う）
* `children_ids`: 子ノード一覧（）
* `type_inference_observers`: 型推論通知用。型推論に影響を与えるノードに、自分を登録する。

### 2.2 変数テーブル

```python
TsuchinokoName.var_table = {
  'x': { 'scope_id': 1, 'type': 'i32' },
  'y': { 'scope_id': 2, 'type': 'Vec<i32>' },
}
```

* `scope_id` には、`parent_id` を設定する。

### 2.3 仮引数ノード

関数定義の仮引数（`ast.arg`）も `TsuchinokoArg` ノードとして生成され、通常のノードと同様に型推論・コード生成対象となる。これは `TsuchinokoFunctionDef` の初期化処理内で生成され、スコープ情報および型情報は型推論サイクルで処理される。

---
## 3. 3サイクル処理モデル（SA）

### 3.1 サイクル1：ノードツリー構築＆スコープ付与

* 全ノードに `node_id` を付与。
* スコープ境界（関数・if・for）ではスコープ分離
* 親ノードとの双方向リンク(`parent_id`, `children_ids`)を構築
* 型推論に影響するノードの `type_inference_observers` に自身をサブスクライバー登録（各Nodeにメソッドを用意する）

### 3.2 サイクル2：型推論伝播（オブザーバーパターン）

* 影響ノードが型を持つと、登録元に通知
* 登録元は型情報が揃った段階で、自身の型を確定し、さらに上位へ通知
* 型が確定すれば `var_table` に登録

### 3.3 サイクル3：コード生成（emit\_rust）

* すべてのノードで `emit_rust()` を実装
* 宣言・関数定義・式などを型に応じて適切なRust構文へ変換
* `let`, `mut`, `Vec`, `Option`, `match` などRust特有構文にも対応
* タプル代入において：

  * 左辺がタプル形式の場合、`let` は付与しない（既存変数とみなされる）
  * 新規変数の場合に限り `let` を付与する

---

## 4. ファイル構成（SS：System Structure）

```
Tsuchinoko/
├── src/
│   ├── compiler.py             # コンパイラメイン処理
│   ├── matcher.py              # TsuchinokoNodeのマッチャー管理
│   ├── ir_base.py              # TsuchinokoNodeベース定義
│   ├── ir_nodes.py             # 各種ノード定義（If, Assign, FunctionDef 等）
│   └── (codegen_rust.py)       # Rustコード出力支援（未定義なら分離予定）
├── tests/                      # 単体テスト群
└── pcc                        # CLIエントリポイント（パイソンのバッチプログラム）
```

---

## 5. UI仕様（UI）

### 5.1 入力

* Pythonソースコード（ファイル/文字列）

### 5.2 出力

* Rustソースコード（ファイル出力）
* 中間生成物として、スコープ・型情報ログも出力可能

### 5.3 デバッグ出力

* `--debug` オプションにより：

  * TsuchinokoNodeの型情報
  * スコープマップ
  * AST変換ツリー

### 5.4 CLIツール `pcc` 使用方法

```bash
$ ./pcc input.py

Options:
  --debug         変換処理のデバッグ情報を出力（型情報・スコープ構造など）
  -o output.rs    出力先Rustファイルを指定（デフォルトは input.rs）
```

---

## 6. 今後の拡張性（設計方針）

* 型推論強化（複合型, クラス, 型ヒント対応）
* クラス・メソッド構文対応
* ラムダ、yield、async などの非同期構文サポート
* 複数ファイル、依存関係対応
* import ライブラリモジュール対応
* 最終的には WASM / LLVMバックエンドへの変換も視野に

---

このドキュメントは、Tsuchinoko を第三者が完全に自作できることを目的とし、すべての構成・処理を構造的に説明するものです。
