# Tsuchinoko V1.7.0 API 仕様書 (RPC プロトコル)

> **バージョン**: 1.7.0 (Maximum A)
> **最終更新**: 2026-01-10

このドキュメントは、Rust Runtime (Bridge) と Python Resident Worker 間で使用される JSON RPC プロトコルを定義する。

---

## 1. プロトコル基礎

*   **フォーマット**: NDJSON (Newline Delimited JSON) over Stdin/Stdout.
*   **エンコーディング**: UTF-8.
*   **セッション**: 全てのコマンドは `session_id` を保持する。
*   **リクエストID**: 任意の `req_id` (文字列/整数) を付与可能。レスポンスには同じ `req_id` が返される（推奨）。

## 2. データ型 (Tagged Union)

### 2.1 TnkValue

全ての値は `TaggedUnion` 形式で表現される。

```typescript
type TnkValue =
  | { kind: "value", value: number | string | boolean | null }
  | { kind: "handle", id: string, type: string, repr: string, session_id: string }
  | { kind: "list", items: TnkValue[] }
  | { kind: "tuple", items: TnkValue[] }
  | { kind: "dict", items: {key: TnkValue, value: TnkValue}[] };
```

> [!NOTE]
> `handle.session_id` は整合性検証・デバッグ用であり、Workerは `cmd.session_id` を優先する。
> 不一致の場合は `ProtocolError` (または `StaleHandle`) を返す。

> [!NOTE]
> `dict` の `key` は任意の `TnkValue` を許可する（Python互換）。
> Rust 側は必要に応じて `String` キーへ制限した `DictStr` 表現を別途提供してよい（将来拡張）。

---

## 3. コマンドリクエスト (Rust -> Worker)

### 3.1 共通構造

```json
{
  "cmd": "COMMAND_NAME",
  "session_id": "UUID",
  "req_id": "optional-id-1",
  ...parameters
}
```

### 3.2 コマンド一覧 (Maximum A)

#### `call_method`
オブジェクトのメソッドを呼び出す。

```json
{
  "cmd": "call_method",
  "session_id": "uuid-...",
  "target": "handle_id",
  "method": "method_name",
  "args": [ { ...TnkValue... }, ... ]
}
```

#### `get_attribute`
プロパティや属性を取得する。**制限**: `_` で始まる属性へのアクセスは禁止。

```json
{
  "cmd": "get_attribute",
  "session_id": "uuid-...",
  "target": "handle_id",
  "name": "attribute_name"
}
```

#### `get_item`
インデックスまたはキーで要素を取得する (`obj[key]`)。

```json
{
  "cmd": "get_item",
  "session_id": "uuid-...",
  "target": "handle_id",
  "key": { ...TnkValue... }
}
```

#### `slice`
スライスを取得する (`obj[start:stop:step]`)。

**引数ルール**:
*   `kind: "value"` の場合: `number | null` (null = Python None) のみ許可。
*   `kind: "handle"` の場合: Worker が `int` へのデコードを試みる（失敗時は `TypeMismatch`）。
*   `step` が `0` の場合: `PythonException` (ValueError) を返す。

```json
{
  "cmd": "slice",
  "session_id": "uuid-...",
  "target": "handle_id",
  "start": { ...TnkValue... },
  "stop": { ...TnkValue... },
  "step": { ...TnkValue... }
}
```

#### `iter`
イテレータブルなオブジェクトからイテレータハンドルを取得する。

```json
{
  "cmd": "iter",
  "session_id": "uuid-...",
  "target": "handle_id"
}
```

#### `iter_next_batch`
イテレータから次のバッチ要素を取得する。

```json
{
  "cmd": "iter_next_batch",
  "session_id": "uuid-...",
  "target": "iterator_handle_id",
  "batch_size": 1000
}
```

#### `delete`
オブジェクトをストアから解放する。**Idempotent (冪等)** - 存在しないIDでもエラーにならない。

```json
{
  "cmd": "delete",
  "session_id": "uuid-...",
  "target": "handle_id"
}
```

---

## 4. レスポンス (Worker -> Rust)

### 4.1 成功 (Success)

```json
{
  "kind": "ok",
  "req_id": "optional-id-1",
  "value": { ...TnkValue... },
  "meta": {
    "done": boolean // オプション。iter_next_batch で StopIteration に到達した場合 true
  }
}
```

### 4.2 エラー (Error)

```json
{
  "kind": "error",
  "req_id": "optional-id-1",
  "error": {
    "code": "ErrorCode",
    "py_type": "ValueError", // オプション。PythonException の場合の例外型名
    "message": "エラー詳細...",
    "traceback": "Traceback文字列...",
    "op": { ...元のコマンド... }
  }
}
```

### 4.3 エラーコード定義

| コード | 説明 |
|---|---|
| `ProtocolError` | JSONフォーマット不正、必須フィールド欠落、未知のコマンド、Session ID不一致。 |
| `StaleHandle` | 指定された Handle ID がセッションストアに見つからない。 |
| `WorkerCrash` | Worker プロセスが予期せず終了した (パイプエラー等で検知)。 |
| `ValueTooLarge` | `.to_value()` の結果がサイズ制限を超過した。 |
| `SecurityViolation` | `_` 属性へのアクセス、`eval`、`exec` など禁止操作の試行。 |
| `PythonException` | 標準的な Python 例外 (IndexError, KeyError, etc.)。 |
| `TypeMismatch` | そのオブジェクト型に対してサポートされていない操作 (例: intのスライス)。 |

---

## 5. 通信例 (Examples)

### 5.1 単純なメソッド呼び出し

**Request**:
```json
{ "cmd": "call_method", "session_id": "s1", "req_id": "r1", "target": "h_df", "method": "head", "args": [{"kind":"value", "value":1}] }
```
**Response**:
```json
{ "kind": "ok", "req_id": "r1", "value": {"kind": "handle", "id": "h_df_head", "type": "DataFrame", ...} }
```

### 5.2 変数を使ったスライス

**Request**:
```json
{
  "cmd": "slice",
  "session_id": "s1",
  "req_id": "r2",
  "target": "h_arr",
  "start": {"kind":"handle", "id":"h_start_idx"},
  "stop": {"kind":"value", "value":100},
  "step": {"kind":"value", "value":1}
}
```

### 5.3 イテレータ終了

**Request**: `iter_next_batch`
**Response**:
```json
{
  "kind": "ok",
  "req_id": "r3",
  "value": {"kind": "list", "items": []},
  "meta": {"done": true}
}
```
